<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Audio Sample Player</title>
</head>
<body>
    <select id="fileSelect"></select>
    <button onclick="loadSample()">Load Sample</button>
    <canvas id="audioCanvas"></canvas>
    <input type="number" id="frequencyInput" value="100">
    <button onclick="playAudio()">Play</button>
    <button onclick="stopAudio()">Stop</button>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let audioBuffer;
        let source;

        window.onload = async () => {
            const response = await fetch('/filenames');
            const filenames = await response.json();
            const select = document.getElementById('fileSelect');
            filenames.forEach(file => {
                const option = document.createElement('option');
                option.value = file;
                option.innerText = file;
                select.appendChild(option);
            });
        };

        async function loadSample() {
            const filename = document.getElementById('fileSelect').value;
            const response = await fetch(`/audio-out/${filename}`);
            const arrayBuffer = await response.arrayBuffer();
            audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            drawWaveform(audioBuffer);
        }

        function drawWaveform(audioBuffer) {
            const canvas = document.getElementById('audioCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = 200;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const bufferLength = audioBuffer.length;
            const dataArray = audioBuffer.getChannelData(0);
            const sliceWidth = canvas.width * 1.0 / bufferLength;
            let x = 0;

            ctx.beginPath();
            ctx.lineJoin = 'round';
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#000000';

            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] * 100;
                const y = canvas.height / 2 + v;

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                x += sliceWidth;
            }

            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();
        }

        function playAudio() {
            const frequency = document.getElementById('frequencyInput').value;
            if (audioBuffer && !source) {
                source = audioCtx.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioCtx.destination);
                source.start(0);
            }
        }

        function stopAudio() {
            if (source) {
                source.stop();
                source = null;
            }
        }
    </script>
</body>
</html>
